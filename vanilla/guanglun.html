<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    span:hover {
      background-color: yellow;
      cursor: pointer;
    }

    span.active:hover {
      background-color: lightblue;
      cursor: pointer;
    }

    span.active {
      background-color: lightblue;
      cursor: pointer;
    }

    span.guanglun {
      font-family: 標楷體;
      font-size: 1.2em;
    }
    button {
      font-family: 標楷體;
      font-size: 1.2em;
    }

    .container {
      position: relative;
      width: 100%;
      height: 100px;
      overflow: auto;
    }
  </style>
</head>

<body>
  <input type="file" id="fileElem" accept=".txt" style="display:none">
  <button id="fileSelect">從本文檔載入音檔資料到下面的文字方塊</button>
  <button id="btnConvert">廣論原文</button>
  <textarea id="data" rows="20" cols="60" style="display:block; font-size:1.2em;">
[
 {
    "newpar": false,
    "source":"第二說法軌理分四,一思惟說法所有勝利,二發起承事大師及法,三以何意樂加行而說,四於何等境應說不說所有差別。",
    "startvol":"12b",
    "starttime":"7:12",
    "endtime":"10:8"
 }, 
 {
    "newpar": true,
    "source":"若不顧慮利養恭敬名等染事，而說法者勝利極大。《勸發增上意樂》中云：「慈氏，無染法施，謂不希欲，利養恭敬，而施法施。此二十種是其勝利。",
    "startvol":"12b",
    "starttime":"10:08",
    "endtime":"12:22"
 }
]
</textarea>
  <div width="100%" id="source" class="container">
  </div>
  <div>
    <iframe width="100%" height="450px" id="iframe"></iframe>
  </div>
  <script>
    const title1 = "在下面的文字方塊中填上音檔相關資料後，按本鍵製作音檔連結";
    const title2 = "要更新音檔資料，請按此鍵";
    const fileSelect = document.getElementById("fileSelect");
    const fileElem = document.getElementById("fileElem");
    fileSelect.addEventListener("click", (e) => {
        if (fileElem) {
          fileElem.click();
        }
    }, false);
    fileElem.addEventListener("change",loadFile);
    var data = [{
      "newpar": false,
      "source": "第二說法軌理分四,一思惟說法所有勝利,二發起承事大師及法,三以何意樂加行而說,四於何等境應說不說所有差別。",
      "startvol": "12b",
      "starttime": "7:12",
      "endtime": "10:8"
    }, {
      "newpar": true,
      "source": "若不顧慮利養恭敬名等染事，而說法者勝利極大。《勸發增上意樂》中云：「慈氏，無染法施，謂不希欲，利養恭敬，而施法施。此二十種是其勝利。",
      "startvol": "12b",
      "starttime": "10:08",
      "endtime": "12:22"
    }
    ];
    var curparagraph = null;
    const iframe = document.getElementById('iframe');
    const btnConvert = document.getElementById("btnConvert");
    btnConvert.setAttribute("title", title1);
    const textareaData = document.getElementById("data");
    const sourceDiv = document.getElementById("source");
    var activeSpan = null;
    function setYinDang(element) {
      if (activeSpan == element) return;
      if (activeSpan != null)
        activeSpan.classList.remove("active");
      activeSpan = element;
      element.classList.add("active");
      iframe.setAttribute("src", element.getAttribute("src"));
    }
    function setup(data) {
      curparagraph = null;
      activeSpan = null;
      sourceDiv.innerHTML = "";
      data.forEach((item) => {
        if (item.newpar || curparagraph == null) {
          curparagraph = document.createElement("p");
          sourceDiv.appendChild(curparagraph)
        }
        var span = document.createElement("span");
        span.classList.add("guanglun");
        span.textContent = item.source;
        var src = `https://lamrim.xyz/player2/?&tch=gl1&af1=${item.startvol}&st1=${minsec2sec(item.starttime)}`;
        if (item.endvol && item.endvol != item.startvol) {
          src = src + `&af2=${item.endvol}&et2=${minsec2sec(item.endtime)}`
        } else {
          src = src + `&et1=${minsec2sec(item.endtime)}`
        }
        span.setAttribute("src", src);
        span.addEventListener("click", (ev) => setYinDang(ev.target));
        curparagraph.appendChild(span)
      })
    }
    function minsec2sec(minsec) {
      var tokens = minsec.split(":")
      if (tokens.length == 1)
        return parseInt(minsec);
      else if (tokens.length == 2) {
        return parseInt(tokens[0]) * 60 + parseInt(tokens[1]);
      }
      else return 0;
    }
    function handleBtnConvert(ev) {
      //console.log(ev.target.textContent)
      if (btnConvert.textContent == "廣論原文") {
        try {
          data = JSON.parse(textareaData.value);
          setup(data);
        }
        catch (err) {
          alert(err);
          return;
        }
        sourceDiv.style.display = "block"
        textareaData.style.display = "none"
        btnConvert.textContent = "音檔資料";
        fileSelect.style.display = "none";
        btnConvert.setAttribute("title", title2);
      } else {
        sourceDiv.style.display = "none"
        textareaData.style.display = "block"
        fileSelect.style.display = "inline";
        btnConvert.textContent = "廣論原文"
        btnConvert.setAttribute("title", title1);
      }
    }
    btnConvert.addEventListener("click", handleBtnConvert)
    function loadFile(ev){
      //console.log(ev.target.files[0]);
      ev.preventDefault();
      if (ev.target.files.length>0){
        var file = ev.target.files[0];
        var reader = new FileReader()
        reader.onloadend=(event)=>{
          textareaData.value=event.target.result
        }
        reader.readAsText(file)
      }
    }
  //setup(data);
  </script>
</body>

</html>